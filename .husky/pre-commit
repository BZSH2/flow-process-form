#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ å¼€å§‹ä»£ç æ£€æŸ¥..."

# è·å–æš‚å­˜çš„æ–‡ä»¶
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo "âœ… æ²¡æœ‰éœ€è¦æ£€æŸ¥çš„æ–‡ä»¶"
  exit 0
fi

echo "ğŸ“ æ£€æŸ¥æ–‡ä»¶:"
echo "$STAGED_FILES" | sed 's/^/  /'

# 1. è¿è¡Œ lint-staged
echo "ğŸ” è¿è¡Œä»£ç æ£€æŸ¥å’Œæ ¼å¼åŒ–..."
# npm run lint:all

if [ $? -ne 0 ]; then
  echo "âŒ ä»£ç æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤ä»¥ä¸Šé—®é¢˜"
  exit 1
fi

# 2. å¦‚æœæœ‰ä¿®æ”¹ï¼Œé‡æ–°æ·»åŠ æ–‡ä»¶
git add $STAGED_FILES 2>/dev/null || true

# 3. TypeScript ç±»å‹æ£€æŸ¥
echo "ğŸ” è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥..."
if [ -f "node_modules/.bin/vue-tsc" ]; then
  npm run typecheck
  
  if [ $? -ne 0 ]; then
    echo "âŒ TypeScript ç±»å‹æ£€æŸ¥å¤±è´¥"
    exit 1
  fi
fi

echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼"